<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Cotizador Jazz - Profesional</title>
    <style>
        :root { 
            --color-principal: #2c3e50; 
            --color-acento: #3498db; 
            --color-verde: #25d366; 
            --color-naranja: #f39c12; 
            --color-rojo: #e74c3c;
            --color-morado: #6c5ce7;
            --color-gris: #34495e;
        }

        body { font-family: 'Segoe UI', sans-serif; background: #cbd5e0; margin: 0; display: flex; height: 100vh; overflow: hidden; transition: 0.3s; }

        /* PANEL CONTROL COLAPSABLE */
        #panelControl { 
            width: 380px; 
            background: #f0f2f5; 
            height: 100%; 
            padding: 15px; 
            border-right: 1px solid #ccc; 
            overflow-y: auto; 
            box-sizing: border-box; 
            flex-shrink: 0; 
            transition: margin-left 0.3s ease;
            position: relative;
        }

        #panelControl.hidden { margin-left: -380px; }

        /* Bot√≥n para esconder/mostrar panel */
        #togglePanelBtn {
            position: fixed;
            left: 10px;
            top: 10px;
            z-index: 999;
            background: var(--color-principal);
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        @media (max-width: 1024px) {
            body { flex-direction: column; overflow-y: auto; height: auto; }
            #panelControl { width: 100% !important; height: auto !important; border-right: none !important; border-bottom: 1px solid #ccc; margin-left: 0 !important; }
            #areaCotizacion { width: 100% !important; padding: 10px !important; }
            .container-nota { width: 95% !important; padding: 15px !important; }
            /* Ajuste en m√≥vil para que no se encime */
            .folio-container { position: absolute !important; top: 10px !important; right: 20px !important; }
            #togglePanelBtn { display: none; }
        }

        .acordeon-header { background: var(--color-principal); color: white; padding: 10px; font-size: 0.85rem; font-weight: bold; cursor: pointer; border-radius: 4px; margin-bottom: 5px; display: flex; align-items: center; justify-content: space-between; }
        .acordeon-content { background: white; padding: 10px; border: 1px solid #ddd; border-radius: 0 0 4px 4px; margin-bottom: 10px; display: block; }

        .grid-config { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .input-group { border: 1px solid #eee; padding: 5px; border-radius: 4px; position: relative; }
        .input-group label { font-size: 10px; font-weight: bold; color: #333; display: block; }
        .input-group input { width: 100%; border: 1px solid #ccc; padding: 4px; font-size: 12px; box-sizing: border-box; }
        .btn-del { color: red; font-size: 9px; cursor: pointer; position: absolute; right: 5px; top: 5px; border: none; background: none; }

        .box-costo { background: var(--color-principal); color: white; padding: 15px; border-radius: 8px; text-align: center; margin: 15px 0; }
        .box-costo div { font-size: 24px; font-weight: bold; }
        .btn-agregar-main { background: var(--color-acento); color: white; border: none; width: 100%; padding: 12px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 16px; }

        #areaCotizacion { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; transition: 0.3s; }
        .container-nota { width: 850px; background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: relative; min-height: 900px; }
        
        /* CAMBIO AQU√ç: Se aument√≥ right de 40px a 75px para moverlo a la izquierda */
        .folio-container { position: absolute; top: 30px; right: 75px; border: 2px solid var(--color-rojo); color: var(--color-rojo); text-align: center; padding: 5px 10px; font-weight: bold; min-width: 90px; z-index: 10; background: white; }
        .folio-container span { font-size: 18px; display: block; }
        
        .info-inputs { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px; }
        .info-inputs div label { font-size: 9px; font-weight: bold; display: block; color: #666; }
        .info-inputs div input { width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; box-sizing: border-box; }

        .editable-data { border: 1px dashed transparent; transition: 0.3s; padding: 5px; cursor: edit; }
        .editable-data:hover { border-color: var(--color-acento); background: #f7fbff; }
        .editable-data:focus { border: 1px solid var(--color-acento); outline: none; background: white; }

        table { width: 100%; border-collapse: collapse; margin-top: 30px; }
        th { border-bottom: 2px solid #333; padding: 10px; text-align: left; font-size: 12px; background: #f8f9fa; }
        td { border-bottom: 1px solid #eee; padding: 5px; }
        .td-in input { width: 100%; border: none; padding: 5px; font-size: 13px; background: transparent; }
        .td-in input:focus { background: #fffde7; outline: none; }
        
        .btn-x { color: var(--color-rojo); border: none; background: none; font-weight: bold; cursor: pointer; font-size: 18px; line-height: 1; }

        .nota-footer-btns { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 40px; }
        .btn-f { padding: 12px 20px; border-radius: 6px; border: none; color: white; font-weight: bold; cursor: pointer; min-width: 130px; transition: 0.2s; }
        
        .tabla-totales { width: 250px; margin-left: auto; margin-top: 15px; }
        .tabla-totales td { border: none; padding: 4px; text-align: right; font-size: 15px; }

        #modalCotizaciones { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; justify-content:center; align-items:center; }
        .modal-cont { background:white; padding:20px; border-radius:8px; width:500px; max-height:70vh; overflow-y:auto; }
        .btn-mas { background:var(--color-acento); color:white; border:none; width:30px; height:30px; border-radius:50%; cursor:pointer; font-weight:bold; margin-top:10px; }

        @media print { 
            .no-print { display: none !important; } 
            body { background: white; } 
            .container-nota { box-shadow: none; border: none; width: 100%; padding: 0; position: relative !important; }
            /* Ajuste extra para la impresi√≥n: asegurar que el folio no se pegue al borde derecho del papel */
            .folio-container { position: absolute !important; top: 0 !important; right: 40px !important; -webkit-print-color-adjust: exact; }
        }
    </style>
</head>
<body>
    <button id="togglePanelBtn" class="no-print" onclick="toggleSidebar()">‚ò∞</button>

    <aside id="panelControl" class="no-print">
        <h3 style="margin-top:40px;">Panel de Control</h3>
        <div class="acordeon-header" onclick="toggleSection(this)"><span>‚öôÔ∏è CONFIGURAR PRECIOS PROCESOS</span> <b>‚ñº</b></div>
        <div class="acordeon-content">
            <button onclick="nuevoProc()" style="background:var(--color-verde); color:white; border:none; width:100%; padding:8px; margin-bottom:10px; border-radius:4px; font-weight:bold;">+ AGREGAR PROCESO</button>
            <div id="contProcs" class="grid-config"></div>
            <button onclick="saveProcs()" style="background:var(--color-naranja); color:white; border:none; width:100%; padding:10px; margin-top:10px; border-radius:4px; font-weight:bold;">üíæ GUARDAR PROCESOS</button>
        </div>

        <div class="acordeon-header" onclick="toggleSection(this)"><span>üìÑ CONFIGURAR PRECIOS PAPEL</span> <b>‚ñº</b></div>
        <div class="acordeon-content">
            <button onclick="nuevoPapel()" style="background:var(--color-acento); color:white; border:none; width:100%; padding:8px; margin-bottom:10px; border-radius:4px; font-weight:bold;">+ AGREGAR PAPEL</button>
            <div id="contPapel" class="grid-config"></div>
            <button onclick="savePapeles()" style="background:var(--color-naranja); color:white; border:none; width:100%; padding:10px; margin-top:10px; border-radius:4px; font-weight:bold;">üíæ GUARDAR PAPELES</button>
        </div>

        <div class="acordeon-header" onclick="toggleSection(this)"><span>II. SELECCI√ìN DE TRABAJO</span> <b>‚ñº</b></div>
        <div class="acordeon-content">
            <label style="font-size:11px; font-weight:bold;">CANTIDAD DE PIEZAS</label>
            <input type="number" id="inpPiezas" value="300" style="width:100%; padding:8px; margin:5px 0 10px 0; border:1px solid #ccc;" oninput="calcCosto()">
            
            <label style="font-size:11px; font-weight:bold;">AUTOCOPIABLE</label>
            <select id="selPapel" style="width:100%; padding:8px; margin-top:5px; border:1px solid #ccc;" onchange="checkAuto(this)">
                <option value="0">Ninguno / Otro</option>
                <option value="AUTO">AUTOCOPIABLE</option>
            </select>

            <div id="optsAuto" style="display:none; margin-top:10px; padding:5px; background:#f9f9f9; border:1px solid #ddd; border-radius:4px;">
                <label style="font-size:11px; display:block;"><input type="checkbox" id="chkOri" onchange="calcCosto()"> Original</label>
                <label style="font-size:11px; display:block;"><input type="checkbox" id="chkInt" onchange="calcCosto()"> Intermedio</label>
                <label style="font-size:11px; display:block;"><input type="checkbox" id="chkFin" onchange="calcCosto()"> Final</label>
            </div>
        </div>

        <div class="acordeon-header" onclick="toggleSection(this)"><span>III. PROCESOS (CANTIDAD)</span> <b>‚ñº</b></div>
        <div class="acordeon-content">
            <div id="contCantidades" class="grid-config"></div>
        </div>

        <div class="box-costo">
            <span style="font-size:12px;">Costo de Producci√≥n:</span>
            <div id="vCosto">$0.00</div>
        </div>

        <div style="margin-bottom:10px;">
            <label style="font-size:10px; font-weight:bold;">GANANCIA SUGERIDA</label>
            <select id="selUtil" style="width:100%; padding:8px; margin-top:5px;" onchange="calcCosto()">
                <option value="1.6">60%</option>
                <option value="1.8">80%</option>
                <option value="2.0" selected>100%</option>
            </select>
        </div>

        <button class="btn-agregar-main" onclick="pushToNota()">+ AGREGAR A COTIZACI√ìN</button>
    </aside>

    <main id="areaCotizacion">
        <div class="container-nota">
            <div class="folio-container">FOLIO <span><b id="fNum">001</b></span></div>
            
            <div style="text-align:center;">
                <div onclick="document.getElementById('lInp').click()" style="cursor:pointer">
                    <img src="https://via.placeholder.com/150x60?text=LOGOTIPO" id="lDisp" style="max-height:80px; margin-bottom:10px;">
                </div>
                <input type="file" id="lInp" style="display:none" onchange="updateLogo(this)">
                
                <h2 contenteditable="true" id="miNombre" onblur="saveBizInfo()" class="editable-data" style="margin:5px 0;">NOMBRE EMPRESA</h2>
                <div contenteditable="true" id="miDetalle" onblur="saveBizInfo()" class="editable-data" style="font-size:11px; line-height:1.4; white-space: pre-wrap;">NOMBRE DUE√ëO
RFC | DIRECCION, CIUDAD
CORREO / TEL </div>
            </div>

            <div class="info-inputs">
                <div><label>CLIENTE:</label><input type="text" id="cCli" placeholder="..." oninput="persistCli()"></div>
                <div><label>WHATSAPP:</label><input type="text" id="cWha" placeholder="33..." oninput="persistCli()"></div>
                <div><label>FECHA:</label><input type="date" id="fHoy"></div>
                <div><label>ENTREGA:</label><input type="date" id="cEnt" oninput="persistCli()"></div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th width="30" class="no-print"></th>
                        <th width="70">CANT.</th>
                        <th>DESCRIPCI√ìN</th>
                        <th width="100">UNIT.</th>
                        <th width="100">TOTAL</th>
                    </tr>
                </thead>
                <tbody id="notaCuerpo"></tbody>
            </table>
            <button class="btn-mas no-print" onclick="insertarFila(0,'',0,0)">+</button>

            <table class="tabla-totales">
                <tr><td>Subtotal:</td><td id="subTotal">$0.00</td></tr>
                <tr><td>IVA (16%):</td><td id="ivaTotal">$0.00</td></tr>
                <tr style="font-weight:bold; font-size: 20px; border-top: 2px solid #333;"><td>TOTAL:</td><td id="nTotal">$0.00</td></tr>
            </table>

            <div class="nota-footer-btns no-print">
                <button class="btn-f" style="background:var(--color-verde);" onclick="enviarWhatsApp()">WhatsApp</button>
                <button class="btn-f" style="background:var(--color-gris);" onclick="window.print()">Imprimir</button>
                <button class="btn-f" style="background:var(--color-morado);" onclick="abrirCotizaciones()">Cotizaciones</button>
                <button class="btn-f" style="background:var(--color-naranja);" onclick="saveFolio()">Guardar Cotizaci√≥n</button>
                <button class="btn-f" style="background:var(--color-rojo);" onclick="resetSistema()">Reset P√°gina</button>
            </div>
        </div>
    </main>

    <div id="modalCotizaciones" class="no-print" onclick="this.style.display='none'">
        <div class="modal-cont" onclick="event.stopPropagation()">
            <h3>Historial de Cotizaciones</h3>
            <div id="listaH"></div>
            <button onclick="document.getElementById('modalCotizaciones').style.display='none'" style="width:100%; margin-top:10px;">Cerrar</button>
        </div>
    </div>

    <script>
        function toggleSidebar() {
            document.getElementById('panelControl').classList.toggle('hidden');
        }

        function saveBizInfo() {
            localStorage.setItem('biz_name', document.getElementById('miNombre').innerText);
            localStorage.setItem('biz_detail', document.getElementById('miDetalle').innerText);
        }
        function persistCli() {
            localStorage.setItem('cli_name', document.getElementById('cCli').value);
            localStorage.setItem('cli_wha', document.getElementById('cWha').value);
            localStorage.setItem('cli_ent', document.getElementById('cEnt').value);
        }
        function loadSavedData() {
            if(localStorage.getItem('biz_name')) document.getElementById('miNombre').innerText = localStorage.getItem('biz_name');
            if(localStorage.getItem('biz_detail')) document.getElementById('miDetalle').innerText = localStorage.getItem('biz_detail');
            if(localStorage.getItem('biz_logo')) document.getElementById('lDisp').src = localStorage.getItem('biz_logo');
            if(localStorage.getItem('cli_name')) document.getElementById('cCli').value = localStorage.getItem('cli_name');
            if(localStorage.getItem('cli_wha')) document.getElementById('cWha').value = localStorage.getItem('cli_wha');
            if(localStorage.getItem('cli_ent')) document.getElementById('cEnt').value = localStorage.getItem('cli_ent');
            let f = localStorage.getItem('f_val_real') || "001";
            document.getElementById('fNum').innerText = f;
        }

        function saveFolio() {
            let num = document.getElementById('fNum').innerText;
            let cliente = document.getElementById('cCli').value || "S/N";
            let total = document.getElementById('nTotal').innerText;
            
            let historial = JSON.parse(localStorage.getItem('historial_c') || "[]");
            historial.push({folio: num, cliente: cliente, total: total});
            localStorage.setItem('historial_c', JSON.stringify(historial));

            let current = parseInt(num);
            let next = current + 1;
            if (next > 1000) next = 1;
            let fPadded = next.toString().padStart(3, '0');
            localStorage.setItem('f_val_real', fPadded);
            document.getElementById('fNum').innerText = fPadded;

            // --- UNICOS CAMBIOS: LIMPIEZA DE DATOS ---
            document.getElementById('notaCuerpo').innerHTML = ""; // Borrar filas de cotizaci√≥n
            document.getElementById('subTotal').innerText = "$0.00";
            document.getElementById('ivaTotal').innerText = "$0.00";
            document.getElementById('nTotal').innerText = "$0.00";
            insertarFila(0, '', 0, 0); // Insertar una fila limpia para el siguiente folio
            // ------------------------------------------

            alert("Cotizaci√≥n guardada.");
        }

        function resetSistema() {
            let pass = prompt("Ingrese la contrase√±a para limpiar los datos (Logo y Empresa):");
            if (pass === "jazz1926") {
                if (confirm("¬øSeguro que desea entregar la p√°gina limpia? Se borrar√° logo, datos de empresa y cliente.")) {
                    localStorage.removeItem('biz_name');
                    localStorage.removeItem('biz_detail');
                    localStorage.removeItem('biz_logo');
                    localStorage.removeItem('cli_name');
                    localStorage.removeItem('cli_wha');
                    localStorage.removeItem('cli_ent');
                    location.reload(); 
                }
            } else if (pass !== null) {
                alert("Contrase√±a incorrecta.");
            }
        }

        function enviarWhatsApp() {
            let tel = document.getElementById('cWha').value.replace(/\D/g,'');
            if(!tel) { alert("Ingrese un n√∫mero de WhatsApp del cliente."); return; }
            
            let empresa = document.getElementById('miNombre').innerText;
            let folio = document.getElementById('fNum').innerText;
            let cliente = document.getElementById('cCli').value || "Cliente";
            let fecha = document.getElementById('fHoy').value;
            let entrega = document.getElementById('cEnt').value || "Pendiente";
            
            let subtotal = document.getElementById('subTotal').innerText;
            let iva = document.getElementById('ivaTotal').innerText;
            let total = document.getElementById('nTotal').innerText;
            
            let msg = `*COTIZACI√ìN ${empresa}*\n`;
            msg += `*Folio:* ${folio}\n`;
            msg += `*Cliente:* ${cliente}\n`;
            msg += `*Fecha Emisi√≥n:* ${fecha}\n`;
            msg += `*Fecha Entrega:* ${entrega}\n`;
            msg += `--------------------------\n`;
            
            document.querySelectorAll('#notaCuerpo tr').forEach(tr => {
                let inputs = tr.querySelectorAll('input');
                if(inputs[1] && inputs[1].value) {
                    msg += `- ${inputs[0].value} ${inputs[1].value}: $${inputs[3].value}\n`;
                }
            });
            
            msg += `--------------------------\n`;
            msg += `*SUBTOTAL:* ${subtotal}\n`;
            msg += `*IVA (16%):* ${iva}\n`;
            msg += `*TOTAL:* ${total}\n\n`;
            msg += `_Gracias por su preferencia._`;
            
            let url = `https://api.whatsapp.com/send?phone=${tel}&text=${encodeURIComponent(msg)}`;
            window.open(url, '_blank');
        }

        function abrirCotizaciones() {
            let h = JSON.parse(localStorage.getItem('historial_c') || "[]");
            let cont = document.getElementById('listaH');
            cont.innerHTML = h.length ? "" : "No hay registros.";
            h.forEach(c => {
                cont.innerHTML += `<div style="border-bottom:1px solid #eee; padding:5px; display:flex; justify-content:space-between;">
                    <span><b>${c.folio}</b> - ${c.cliente} (${c.total})</span>
                    <button onclick="window.print()" style="cursor:pointer;">üñ®Ô∏è</button>
                </div>`;
            });
            document.getElementById('modalCotizaciones').style.display='flex';
        }

        function updateLogo(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => {
                    document.getElementById('lDisp').src = e.target.result;
                    localStorage.setItem('biz_logo', e.target.result);
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function toggleSection(header) {
            const content = header.nextElementSibling;
            content.style.display = (content.style.display === "none") ? "block" : "none";
        }

        function checkAuto(select) {
            document.getElementById('optsAuto').style.display = (select.value === "AUTO") ? "block" : "none";
            calcCosto();
        }

        let procs = JSON.parse(localStorage.getItem('d_procs')) || [
            {n:'Tiro', p:90}, {n:'Placa', p:90}, {n:'Negativo', p:60}, {n:'Folio', p:80},
            {n:'Terminado', p:60}, {n:'Suaje', p:0}, {n:'Suajado', p:0}, {n:'Doblez', p:100},
            {n:'Lam. Brillante', p:7}, {n:'Lam. Matte', p:7}, {n:'Barniz', p:2}, {n:'Engargolado', p:0}
        ];
        let papeles = JSON.parse(localStorage.getItem('d_paps')) || [
            {n:'BOND T/C', p:140}, {n:'AUT. ORIGINAL', p:200}, 
            {n:'AUT. INTERMEDIO', p:220}, {n:'AUT. FINAL', p:290}
        ];

        function init() {
            const contP = document.getElementById('contProcs');
            const contC = document.getElementById('contCantidades');
            const selP = document.getElementById('selPapel');
            const contPap = document.getElementById('contPapel');
            contP.innerHTML = ""; contC.innerHTML = ""; contPap.innerHTML = "";
            selP.innerHTML = '<option value="0">Ninguno / Otro</option><option value="AUTO">AUTOCOPIABLE</option>';
            procs.forEach((item, i) => {
                contP.innerHTML += `<div class="input-group"><button class="btn-del" onclick="procs.splice(${i},1);init()">X</button><label>NOMBRE</label><input value="${item.n}" onchange="procs[${i}].n=this.value"><label>COSTO</label><input type="number" value="${item.p}" onchange="procs[${i}].p=this.value"></div>`;
                contC.innerHTML += `<div class="input-group"><label>CANT. ${item.n.toUpperCase()}</label><input type="number" class="val-proc" data-idx="${i}" value="0" oninput="calcCosto()"></div>`;
            });
            papeles.forEach((item, i) => {
                contPap.innerHTML += `<div class="input-group"><button class="btn-del" onclick="papeles.splice(${i},1);init()">X</button><label>PAPEL</label><input value="${item.n}" onchange="papeles[${i}].n=this.value"><label>MILLA $</label><input type="number" value="${item.p}" onchange="papeles[${i}].p=this.value"></div>`;
                if(!item.n.includes('AUT.')) selP.innerHTML += `<option value="${item.p}">${item.n}</option>`;
            });
            document.getElementById('fHoy').valueAsDate = new Date();
            loadSavedData();
            if(document.getElementById('notaCuerpo').innerHTML.trim() === "") insertarFila(0, '', 0, 0);
        }

        function calcCosto() {
            let total = 0;
            let piezas = parseFloat(document.getElementById('inpPiezas').value) || 0;
            document.querySelectorAll('.val-proc').forEach(input => {
                let idx = input.dataset.idx;
                total += (parseFloat(input.value) || 0) * (procs[idx].p);
            });
            const selP = document.getElementById('selPapel');
            if (selP.value === "AUTO") {
                if(document.getElementById('chkOri').checked) { let p = papeles.find(x => x.n === 'AUT. ORIGINAL')?.p || 0; total += (piezas / 1000) * p; }
                if(document.getElementById('chkInt').checked) { let p = papeles.find(x => x.n === 'AUT. INTERMEDIO')?.p || 0; total += (piezas / 1000) * p; }
                if(document.getElementById('chkFin').checked) { let p = papeles.find(x => x.n === 'AUT. FINAL')?.p || 0; total += (piezas / 1000) * p; }
            } else {
                let millaPapel = parseFloat(selP.value) || 0;
                total += (piezas / 1000) * millaPapel;
            }
            document.getElementById('vCosto').innerText = "$" + total.toFixed(2);
            return total;
        }

        function updateFinalTotal() {
            let sub = 0;
            document.querySelectorAll('.total-in').forEach(input => {
                sub += parseFloat(input.value) || 0;
            });
            let iva = sub * 0.16;
            document.getElementById('subTotal').innerText = "$" + sub.toFixed(2);
            document.getElementById('ivaTotal').innerText = "$" + iva.toFixed(2);
            document.getElementById('nTotal').innerText = "$" + (sub + iva).toFixed(2);
        }

        function pushToNota() {
            let costo = calcCosto();
            let util = parseFloat(document.getElementById('selUtil').value);
            let piezas = parseFloat(document.getElementById('inpPiezas').value) || 1;
            let finalRow = costo * util;
            let unitario = finalRow / piezas;
            
            let rows = document.querySelectorAll('#notaCuerpo tr');
            let firstInput = rows[0]?.querySelector('td:nth-child(3) input');
            
            if(rows.length === 1 && firstInput && firstInput.value === "") {
                let cells = rows[0].querySelectorAll('input');
                cells[0].value = piezas;
                cells[1].value = "Servicio General de Impresi√≥n";
                cells[2].value = unitario.toFixed(2);
                cells[3].value = finalRow.toFixed(2);
                updateFinalTotal();
            } else {
                insertarFila(piezas, "Servicio General de Impresi√≥n", unitario.toFixed(2), finalRow.toFixed(2));
            }
        }

        function insertarFila(cant, desc, unit, total) {
            const tbody = document.getElementById('notaCuerpo');
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="no-print"><button class="btn-x" onclick="this.closest('tr').remove(); updateFinalTotal();">√ó</button></td>
                <td class="td-in"><input type="number" value="${cant || ''}"></td>
                <td class="td-in"><input value="${desc}" onkeydown="if(event.key==='Enter') { event.preventDefault(); insertarFila(0,'',0,0); }"></td>
                <td class="td-in"><input type="number" value="${unit || ''}"></td>
                <td class="td-in"><input type="number" class="total-in" value="${total || ''}" oninput="updateFinalTotal()" style="font-weight:bold;text-align:right;"></td>
            `;
            tbody.appendChild(tr);
            if(desc === '') tr.querySelector('td:nth-child(3) input').focus();
            updateFinalTotal();
        }

        function saveProcs() { localStorage.setItem('d_procs', JSON.stringify(procs)); alert("Guardado"); }
        function savePapeles() { localStorage.setItem('d_paps', JSON.stringify(papeles)); alert("Guardado"); }
        function nuevoProc() { procs.push({n:'Nuevo', p:0}); init(); }
        function nuevoPapel() { papeles.push({n:'Nuevo', p:0}); init(); }

        window.onload = init;
    </script>
</body>
</html>